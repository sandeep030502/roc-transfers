<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ROC 3x Transfers – Live Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font:14px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:20px;color:#111}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:6px 8px;text-align:left;font-size:13px}
    th{background:#fafafa}
    .muted{color:#666}
    .pill{display:inline-block;border-radius:999px;padding:2px 8px;border:1px solid #ddd}
  </style>
</head>
<body>
<header>
  <h2>ROC 3x Transfers – Live Dashboard</h2>
  <div id="info" class="muted">Loading…</div>
</header>

<div class="grid">
  <div class="card">
    <h3>By queue (last 24h)</h3>
    <canvas id="byQueue" height="180"></canvas>
  </div>
  <div class="card">
    <h3>Totals</h3>
    <div id="totals"></div>
  </div>
</div>

<div class="card" style="margin-top:16px">
  <h3>Latest flagged cases</h3>
  <table id="cases">
    <thead><tr><th>Case ID</th><th>Transfers</th><th>Queue</th><th>When</th><th>Link</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(async function(){
  const res = await fetch('data.json', {cache:'no-store'});
  const payload = await res.json(); // { updated, items: [...] }

  const items = payload.items || [];
  const updated = new Date(payload.updated || Date.now());
  document.getElementById('info').textContent =
    `Updated ${updated.toLocaleString()} — ${items.length} total flagged records`;

  const cutoff = Date.now() - 24*60*60*1000;
  const last24 = items.filter(r => Date.parse(r.timestamp) >= cutoff);

  // Totals
  const totalToday = last24.length;
  const uniqueCases = new Set(items.map(r => r.caseId)).size;
  document.getElementById('totals').innerHTML = `
    <div><span class="pill">Last 24h: <b>${totalToday}</b></span></div>
    <div style="margin-top:8px"><span class="pill">Unique cases overall: <b>${uniqueCases}</b></span></div>
  `;

  // By queue (last 24h)
  const byQ = {};
  for (const r of last24) byQ[r.lastQueue || 'Unknown'] = (byQ[r.lastQueue || 'Unknown']||0)+1;
  const labels = Object.keys(byQ);
  const data = Object.values(byQ);
  new Chart(document.getElementById('byQueue'), {
    type: 'bar',
    data: { labels, datasets:[{ label:'Flagged cases', data }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} } }
  });

  // Table (latest 100)
  const tbody = document.querySelector('#cases tbody');
  items.slice(-100).reverse().forEach(r=>{
    const tr = document.createElement('tr');
    const t = new Date(r.timestamp);
    tr.innerHTML = `
      <td>${r.caseId}</td>
      <td>${r.count}</td>
      <td>${r.lastQueue || ''}</td>
      <td class="muted">${t.toLocaleString()}</td>
      <td><a href="${r.url}" target="_blank">Open</a></td>
    `;
    tbody.appendChild(tr);
  });
})();
</script>
</body>
</html>